'use client';

import { createContext, useCallback, useContext, useEffect, useMemo, useState } from 'react';

export type Locale = 'zh' | 'en';

const STORAGE_KEY = 'cgm_locale';

const MESSAGES: Record<Locale, Record<string, string>> = {
  zh: {
    'nav.dashboard': '仪表盘',
    'nav.requirements': '需求',
    'nav.workflows': '工作流',
    'nav.logs': '日志',
    'nav.incidents': '事故',
    'nav.integrations': '集成',
    'nav.settings': '设置',
    'nav.logout': '退出',

    'common.loading': '加载中…',
    'common.refresh': '刷新',
    'common.back': '返回',
    'common.create': '创建',
    'common.search': '搜索',
    'common.upload': '上传',
    'common.loadMore': '加载更多',
    'common.prevPage': '上一页',
    'common.nextPage': '下一页',
    'common.close': '关闭',
    'common.copy': '复制',
    'common.copied': '已复制',
    'common.copyFailed': '复制失败',
    'common.items': '共 {count} 条',
    'common.none': '无',
    'common.yes': '是',
    'common.no': '否',

    'table.time': '时间',
    'table.event': '事件',
    'table.level': '级别',
    'table.sdk': 'SDK',
    'table.app': '应用',
    'table.id': 'ID',
    'table.externalId': '外部 ID',
    'table.title': '标题',
    'table.status': '状态',
    'table.sourceStatus': '来源状态',
    'table.workflow': '工作流',
    'table.stage': '阶段',
    'table.updated': '更新时间',
    'table.logEvents': '日志事件数',
    'table.actions': '操作',

    'project.label': '项目',
    'project.current': '当前项目',
    'project.selectPlaceholder': '请选择项目…',

    'dashboard.title': '仪表盘',
    'dashboard.needProjectHint': '需要先登录并在数据库中有可访问的项目。',
    'dashboard.corePages': '核心页面',
    'dashboard.integrationsAndSettings': '集成与配置',
    'dashboard.adminHint': '默认管理员账号：{email} / {password}（seed 可改）',

    'login.title': '登录',
    'login.desc': '使用 API 的 JWT 登录，token 会保存在浏览器 localStorage。',
    'login.email': '邮箱',
    'login.password': '密码',
    'login.submit': '登录',
    'login.submitting': '登录中…',

    'requirements.title': '需求',
    'requirements.syncIntegrationId': '同步 integrationId（可选）',
    'requirements.sync': '同步',
    'requirements.empty': '暂无数据（需要先在后端 sync requirements 或写入数据）。',

    'workflows.title': '工作流',
    'workflows.empty': '暂无数据（需要先创建 workflow 或通过 requirements sync 自动创建）。',
    'workflow.detail.title': '工作流详情',
    'workflow.stages': '阶段',
    'workflow.stageStatus': '阶段状态',
    'workflow.gate': '闸门',
    'workflow.reason': '原因（override 必填）',
    'workflow.approve': '批准',
    'workflow.override': '强制通过',
    'workflow.noData': '暂无数据',

    'logs.title': '日志',
    'logs.uploadTitle': '上传解码后的 JSONL',
    'logs.uploadHint': '需要上传“解码后的 JSONL”，每行是一个 outer JSON（含字段 c/f/l/...）。',
    'logs.files.browse': '文件列表',
    'logs.files.title': '日志文件',
    'logs.files.backToLogs': '返回日志',
    'logs.files.viewContent': '查看文件内容',
    'logs.files.uploadedAt': '上传时间',
    'logs.files.fileName': '文件名',
    'logs.files.status': '状态',
    'logs.files.events': '事件数',
    'logs.files.errors': '错误数',
    'logs.files.empty': '暂无日志文件',
    'logs.files.detail.title': '文件详情',
    'logs.files.viewerTitle': '文件内容',
    'logs.files.viewerLegend': '事件颜色图例',
    'logs.files.viewerStream': '日志流',
    'logs.files.viewerExpand': '展开详情',
    'logs.files.viewerCollapse': '收起详情',
    'logs.files.viewerPage': '第 {page} / {totalPages} 页',
    'logs.files.viewerLoaded': '已加载 {loaded} / {total} 条',
    'logs.files.openInLogs': '在日志中查看事件',
    'logs.files.delete': '删除文件',
    'logs.files.deleteConfirm':
      '确认删除日志文件“{fileName}”？这将删除相关事件数据与关联关系，且不可恢复。',
    'logs.files.timeRange': '时间范围',
    'logs.files.timeRangeUnknown': '未知',
    'logs.limit': '每页条数',
    'logs.keyword': '关键词（可选）',
    'logs.logFileIdOptional': 'logFileId（可选）',
    'logs.level': '级别',
    'logs.level.all': '全部',
    'logs.levelGte': '最低级别',
    'logs.sdkVersion': 'SDK 版本',
    'logs.appId': '应用 ID',
    'logs.trace': '追踪',
    'logs.stats': '统计',
    'logs.eventNameOptional': 'eventName（可选）',
    'logs.startTime': '开始时间',
    'logs.endTime': '结束时间',
    'logs.preset.1h': '近 1 小时',
    'logs.preset.24h': '近 24 小时',
    'logs.preset.7d': '近 7 天',
    'logs.parserError': '解析错误',
    'logs.onlyParserError': '只看解析错误',
    'logs.detail.title': '事件详情',
    'logs.detail.close': '关闭',
    'logs.detail.copyEventId': '复制事件 ID',
    'logs.detail.copyLogFileId': '复制 logFileId',
    'logs.detail.context': '上下文',
    'logs.detail.current': '当前事件',
    'logs.detail.contextEmpty': '无上下文',
    'logs.detail.msgJson': 'msgJson',
    'logs.detail.rawLine': 'rawLine（仅解析错误）',
    'logs.fileStatus': '解析状态',
    'logs.fileStatus.queued': '队列中',
    'logs.fileStatus.parsed': '已解析',
    'logs.fileStatus.failed': '解析失败',
    'logs.fileStatus.events': '事件数',
    'logs.fileStatus.errors': '错误数',
    'logs.invalidTimeRange': '结束时间需要晚于开始时间',
    'logs.invalidLogFileId': 'logFileId 格式不正确',
    'logs.timeRangeRequired': '请先选择开始时间与结束时间',
    'logs.empty':
      '暂无数据。请先扩大时间范围或稍等解析完成；如怀疑解析失败，可搜索 eventName=PARSER_ERROR。',
    'logs.msgContains': '消息内容包含',
    'logs.msgContainsPlaceholder': '搜索 msgJson 内容',
    'logs.commands': '命令链路',
    'logs.commands.description': '基于 requestId 追踪命令发送和响应的完整链路，快速定位蓝牙通信问题。',
    'logs.commands.stats': '命令统计',
    'logs.commands.total': '总计',
    'logs.commands.success': '成功',
    'logs.commands.timeout': '超时',
    'logs.commands.error': '错误',
    'logs.commands.pending': '待定',
    'logs.commands.avgDuration': '平均耗时',
    'logs.commands.list': '命令列表',
    'logs.commands.events': '事件数',
    'logs.commands.duration': '耗时',
    'logs.commands.status': '状态',
    'logs.commands.eventChain': '事件链',
    'logs.trace.relatedDevices': '关联设备',
    'logs.trace.relatedSessions': '关联会话',
    'common.optional': '可选',
    'common.events': '事件',
    'common.view': '查看',
    'common.noData': '暂无数据',

    'incidents.title': '事故',
    'incidents.titleLabel': '标题',
    'incidents.severity': '严重级别',
    'incidents.status': '状态',
    'incidents.startTime': '开始时间（ISO8601）',
    'incidents.endTime': '结束时间（可选，ISO8601 或留空）',
    'incidents.logEventIds': 'logEventIds（可选，逗号分隔）',
    'incidents.markResolved': '标记已解决',
    'incidents.empty': '暂无数据（需要 Support/Admin 权限）。',

    'severity.low': '低',
    'severity.medium': '中',
    'severity.high': '高',
    'severity.critical': '致命',

    'incidentStatus.open': '开启',
    'incidentStatus.investigating': '排查中',
    'incidentStatus.resolved': '已解决',
    'incidentStatus.closed': '已关闭',

    'integrations.title': '集成',
    'integrations.createEnable': '创建 / 启用',
    'integrations.load': '加载',
    'integrations.mappingJson': 'Mapping JSON',
    'integrations.saveMapping': '保存 mapping',
    'integrations.integrationJson': 'Integration JSON（GET /api/integrations/:id）',

    'projects.name': '名称',
    'projects.type': '类型',
    'projects.status': '状态',
    'projects.role': '角色',
    'projects.current': '当前',
    'projects.setCurrent': '设为当前',

    'settings.title': '设置',
    'settings.apiBaseUrl': 'API Base URL',
    'settings.token': 'Token',
    'settings.tokenPresent': '已存在（{count} 字符）',
    'settings.tokenMissing': '缺失',
    'settings.selectedProjectId': '已选择的 projectId',
    'settings.clearProjectSelection': '清除项目选择',
    'settings.refreshPage': '刷新页面',
    'settings.projects.title': '项目',
    'settings.projects.desc': '创建多个 App 项目并在各页面选择使用。',
    'settings.projects.empty': '暂无可访问的项目。',
    'settings.projects.noMatch': '未匹配到项目。',
    'settings.projects.filter': '过滤（可选）',
    'settings.projects.filterPlaceholder': '按名称 / ID / 类型过滤…',
    'settings.projects.rename': '重命名',
    'settings.projects.renamePrompt': '请输入新的项目名称',
    'settings.projects.renameEmpty': '项目名称不能为空。',
    'settings.projects.archive': '归档',
    'settings.projects.archiveConfirm': '确认归档项目“{name}”？',
    'settings.projects.restore': '恢复',
    'settings.projects.restoreConfirm': '确认恢复项目“{name}”？',
    'settings.projects.updated': '已更新',
    'settings.projects.createName': '项目名称',
    'settings.projects.setAsCurrent': '创建后设为当前项目',
    'settings.projects.createApp': '创建 App 项目',
    'settings.projects.created': '已创建项目：{name}',
    'settings.projects.adminOnly': '需要 Admin 权限才能创建项目。',

    'settings.members.open': '成员',
    'settings.members.title': '项目成员',
    'settings.members.email': '邮箱',
    'settings.members.name': '名称',
    'settings.members.role': '角色',
    'settings.members.createdAt': '加入时间',
    'settings.members.empty': '暂无成员。',
    'settings.members.addTitle': '添加 / 更新成员',
    'settings.members.addHint': '按邮箱添加成员（该邮箱必须已存在于用户表）。如果已存在成员则会更新其角色。',
    'settings.members.add': '添加',
    'settings.members.remove': '移除',
    'settings.members.removeConfirm': '确认从项目“{project}”移除成员 {email}？',
    'settings.members.updated': '成员已更新',
    'settings.members.removed': '已移除：{email}',
  },
  en: {
    'nav.dashboard': 'Dashboard',
    'nav.requirements': 'Requirements',
    'nav.workflows': 'Workflows',
    'nav.logs': 'Logs',
    'nav.incidents': 'Incidents',
    'nav.integrations': 'Integrations',
    'nav.settings': 'Settings',
    'nav.logout': 'Logout',

    'common.loading': 'Loading…',
    'common.refresh': 'Refresh',
    'common.back': 'Back',
    'common.create': 'Create',
    'common.search': 'Search',
    'common.upload': 'Upload',
    'common.loadMore': 'Load more',
    'common.prevPage': 'Prev',
    'common.nextPage': 'Next',
    'common.close': 'Close',
    'common.copy': 'Copy',
    'common.copied': 'Copied',
    'common.copyFailed': 'Copy failed',
    'common.items': '{count} items',
    'common.none': 'None',
    'common.yes': 'Yes',
    'common.no': 'No',

    'table.time': 'Time',
    'table.event': 'Event',
    'table.level': 'Level',
    'table.sdk': 'SDK',
    'table.app': 'App',
    'table.id': 'ID',
    'table.externalId': 'External ID',
    'table.title': 'Title',
    'table.status': 'Status',
    'table.sourceStatus': 'Source status',
    'table.workflow': 'Workflow',
    'table.stage': 'Stage',
    'table.updated': 'Updated',
    'table.logEvents': 'Log events',
    'table.actions': 'Actions',

    'project.label': 'Project',
    'project.current': 'Current project',
    'project.selectPlaceholder': 'Select a project…',

    'dashboard.title': 'Dashboard',
    'dashboard.needProjectHint':
      'Please log in and make sure there is at least one accessible project in the database.',
    'dashboard.corePages': 'Core pages',
    'dashboard.integrationsAndSettings': 'Integrations & settings',
    'dashboard.adminHint': 'Default admin: {email} / {password} (seed can override)',

    'login.title': 'Login',
    'login.desc': 'Sign in with API JWT. The token is stored in browser localStorage.',
    'login.email': 'Email',
    'login.password': 'Password',
    'login.submit': 'Login',
    'login.submitting': 'Logging in…',

    'requirements.title': 'Requirements',
    'requirements.syncIntegrationId': 'Sync integrationId (optional)',
    'requirements.sync': 'Sync',
    'requirements.empty': 'No data. Run requirements sync (or insert data) on the backend first.',

    'workflows.title': 'Workflows',
    'workflows.empty':
      'No data. Create a workflow manually, or let requirements sync create it automatically.',
    'workflow.detail.title': 'Workflow detail',
    'workflow.stages': 'Stages',
    'workflow.stageStatus': 'Stage status',
    'workflow.gate': 'Gate',
    'workflow.reason': 'Reason (required for override)',
    'workflow.approve': 'Approve',
    'workflow.override': 'Override',
    'workflow.noData': 'No data',

    'logs.title': 'Logs',
    'logs.uploadTitle': 'Upload decoded JSONL',
    'logs.uploadHint':
      'Upload decoded JSONL. Each line is an outer JSON entry (with c/f/l/...).',
    'logs.files.browse': 'Files',
    'logs.files.title': 'Log files',
    'logs.files.backToLogs': 'Back to Logs',
    'logs.files.viewContent': 'View content',
    'logs.files.uploadedAt': 'Uploaded',
    'logs.files.fileName': 'File',
    'logs.files.status': 'Status',
    'logs.files.events': 'Events',
    'logs.files.errors': 'Errors',
    'logs.files.empty': 'No log files.',
    'logs.files.detail.title': 'File detail',
    'logs.files.viewerTitle': 'File content',
    'logs.files.viewerLegend': 'Event palette',
    'logs.files.viewerStream': 'Log stream',
    'logs.files.viewerExpand': 'Expand',
    'logs.files.viewerCollapse': 'Collapse',
    'logs.files.viewerPage': 'Page {page} / {totalPages}',
    'logs.files.viewerLoaded': 'Loaded {loaded} / {total}',
    'logs.files.openInLogs': 'Open events in Logs',
    'logs.files.delete': 'Delete',
    'logs.files.deleteConfirm':
      'Delete log file \"{fileName}\"? This will remove related events and links and cannot be undone.',
    'logs.files.timeRange': 'Time range',
    'logs.files.timeRangeUnknown': 'Unknown',
    'logs.limit': 'Page size',
    'logs.keyword': 'Keyword (optional)',
    'logs.logFileIdOptional': 'logFileId (optional)',
    'logs.level': 'Level',
    'logs.level.all': 'All',
    'logs.levelGte': 'Min level',
    'logs.sdkVersion': 'SDK version',
    'logs.appId': 'App ID',
    'logs.trace': 'Trace',
    'logs.stats': 'Stats',
    'logs.eventNameOptional': 'eventName (optional)',
    'logs.startTime': 'Start time',
    'logs.endTime': 'End time',
    'logs.preset.1h': 'Last 1h',
    'logs.preset.24h': 'Last 24h',
    'logs.preset.7d': 'Last 7d',
    'logs.parserError': 'Parser error',
    'logs.onlyParserError': 'Only parser errors',
    'logs.detail.title': 'Event detail',
    'logs.detail.close': 'Close',
    'logs.detail.copyEventId': 'Copy event ID',
    'logs.detail.copyLogFileId': 'Copy logFileId',
    'logs.detail.context': 'Context',
    'logs.detail.current': 'Current event',
    'logs.detail.contextEmpty': 'No context',
    'logs.detail.msgJson': 'msgJson',
    'logs.detail.rawLine': 'rawLine (parser errors only)',
    'logs.fileStatus': 'Parse status',
    'logs.fileStatus.queued': 'Queued',
    'logs.fileStatus.parsed': 'Parsed',
    'logs.fileStatus.failed': 'Failed',
    'logs.fileStatus.events': 'Events',
    'logs.fileStatus.errors': 'Errors',
    'logs.invalidTimeRange': 'End time must be later than start time',
    'logs.invalidLogFileId': 'Invalid logFileId',
    'logs.timeRangeRequired': 'Please select start and end time first',
    'logs.empty':
      'No data. Expand the time range or wait for parsing; failures show as eventName=PARSER_ERROR.',
    'logs.msgContains': 'Message contains',
    'logs.msgContainsPlaceholder': 'Search msgJson content',
    'logs.commands': 'Commands',
    'logs.commands.description': 'Track command send/response chains by requestId for BLE communication debugging.',
    'logs.commands.stats': 'Command Statistics',
    'logs.commands.total': 'Total',
    'logs.commands.success': 'Success',
    'logs.commands.timeout': 'Timeout',
    'logs.commands.error': 'Error',
    'logs.commands.pending': 'Pending',
    'logs.commands.avgDuration': 'Avg Duration',
    'logs.commands.list': 'Command List',
    'logs.commands.events': 'Events',
    'logs.commands.duration': 'Duration',
    'logs.commands.status': 'Status',
    'logs.commands.eventChain': 'Event Chain',
    'logs.trace.relatedDevices': 'Related Devices',
    'logs.trace.relatedSessions': 'Related Sessions',
    'common.optional': 'optional',
    'common.events': 'Events',
    'common.view': 'View',
    'common.noData': 'No data',

    'incidents.title': 'Incidents',
    'incidents.titleLabel': 'Title',
    'incidents.severity': 'Severity',
    'incidents.status': 'Status',
    'incidents.startTime': 'startTime (ISO8601)',
    'incidents.endTime': 'endTime (optional, ISO8601 or blank)',
    'incidents.logEventIds': 'logEventIds (optional, comma-separated)',
    'incidents.markResolved': 'Mark resolved',
    'incidents.empty': 'No data (requires Support/Admin permission).',

    'severity.low': 'low',
    'severity.medium': 'medium',
    'severity.high': 'high',
    'severity.critical': 'critical',

    'incidentStatus.open': 'open',
    'incidentStatus.investigating': 'investigating',
    'incidentStatus.resolved': 'resolved',
    'incidentStatus.closed': 'closed',

    'integrations.title': 'Integrations',
    'integrations.createEnable': 'Create / Enable',
    'integrations.load': 'Load',
    'integrations.mappingJson': 'Mapping JSON',
    'integrations.saveMapping': 'Save mapping',
    'integrations.integrationJson': 'Integration JSON (GET /api/integrations/:id)',

    'projects.name': 'Name',
    'projects.type': 'Type',
    'projects.status': 'Status',
    'projects.role': 'Role',
    'projects.current': 'Current',
    'projects.setCurrent': 'Set current',

    'settings.title': 'Settings',
    'settings.apiBaseUrl': 'API Base URL',
    'settings.token': 'Token',
    'settings.tokenPresent': 'Present ({count} chars)',
    'settings.tokenMissing': 'Missing',
    'settings.selectedProjectId': 'Selected projectId',
    'settings.clearProjectSelection': 'Clear project selection',
    'settings.refreshPage': 'Refresh page',
    'settings.projects.title': 'Projects',
    'settings.projects.desc': 'Create multiple App projects and pick them across pages.',
    'settings.projects.empty': 'No accessible projects.',
    'settings.projects.noMatch': 'No matching projects.',
    'settings.projects.filter': 'Filter (optional)',
    'settings.projects.filterPlaceholder': 'Filter by name / ID / type…',
    'settings.projects.rename': 'Rename',
    'settings.projects.renamePrompt': 'Enter a new project name',
    'settings.projects.renameEmpty': 'Project name cannot be empty.',
    'settings.projects.archive': 'Archive',
    'settings.projects.archiveConfirm': 'Archive project “{name}”?',
    'settings.projects.restore': 'Restore',
    'settings.projects.restoreConfirm': 'Restore project “{name}”?',
    'settings.projects.updated': 'Updated',
    'settings.projects.createName': 'Project name',
    'settings.projects.setAsCurrent': 'Set as current after creation',
    'settings.projects.createApp': 'Create App project',
    'settings.projects.created': 'Created project: {name}',
    'settings.projects.adminOnly': 'Admin permission is required to create projects.',

    'settings.members.open': 'Members',
    'settings.members.title': 'Project members',
    'settings.members.email': 'Email',
    'settings.members.name': 'Name',
    'settings.members.role': 'Role',
    'settings.members.createdAt': 'Joined at',
    'settings.members.empty': 'No members.',
    'settings.members.addTitle': 'Add / update member',
    'settings.members.addHint':
      'Add a member by email (the email must exist in users). If the member already exists, it will update the role.',
    'settings.members.add': 'Add',
    'settings.members.remove': 'Remove',
    'settings.members.removeConfirm': 'Remove {email} from project “{project}”?',
    'settings.members.updated': 'Member updated',
    'settings.members.removed': 'Removed: {email}',
  },
};

function interpolate(template: string, vars: Record<string, string | number> | undefined) {
  if (!vars) return template;
  return template.replace(/\{(\w+)\}/g, (_, k: string) =>
    Object.prototype.hasOwnProperty.call(vars, k) ? String(vars[k]) : `{${k}}`,
  );
}

function translate(locale: Locale, key: string, vars?: Record<string, string | number>) {
  const msg = MESSAGES[locale][key] ?? MESSAGES.zh[key] ?? key;
  return interpolate(msg, vars);
}

type I18nContextValue = {
  locale: Locale;
  localeTag: 'zh-CN' | 'en-US';
  setLocale: (next: Locale) => void;
  t: (key: string, vars?: Record<string, string | number>) => string;
};

const I18nContext = createContext<I18nContextValue | null>(null);

export function I18nProvider(props: { children: React.ReactNode }) {
  const [locale, setLocaleState] = useState<Locale>('zh');

  useEffect(() => {
    const id = window.setTimeout(() => {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved === 'zh' || saved === 'en') setLocaleState(saved);
    }, 0);
    return () => window.clearTimeout(id);
  }, []);

  const setLocale = useCallback((next: Locale) => {
    setLocaleState(next);
    localStorage.setItem(STORAGE_KEY, next);
  }, []);

  const localeTag = locale === 'zh' ? 'zh-CN' : 'en-US';

  useEffect(() => {
    document.documentElement.lang = localeTag;
  }, [localeTag]);

  const value = useMemo<I18nContextValue>(
    () => ({
      locale,
      localeTag,
      setLocale,
      t: (key, vars) => translate(locale, key, vars),
    }),
    [locale, localeTag, setLocale],
  );

  return <I18nContext.Provider value={value}>{props.children}</I18nContext.Provider>;
}

export function useI18n() {
  const ctx = useContext(I18nContext);
  if (!ctx) {
    throw new Error('useI18n must be used within I18nProvider');
  }
  return ctx;
}
